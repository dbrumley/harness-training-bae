var ticket=0;var max_time=0;var elapsed_time=0;function init(){loadIPs();onAdvancedChanged()}var ip_regex=/^((25[0-5]|2[0-4]\d|[01]\d\d|\d?\d)\.){3}(25[0-5]|2[0-4]\d|[01]\d\d|\d?\d)$/;function validateInput(){var a=true;$("#results").html("");if($("#dst_addr_select").val()=="0"){var b=$("#dst_addr_input").val();a=ip_regex.exec(b)!=null&&b!="0.0.0.0";if(!a){$("#results").append("IP address is invalid.<br/>")}}if($("#show_adv").is(":checked")){var c=parseInt($("#time_limit").val());if(c==0||isNaN(c)){a=false;$("#results").append("Duration is invalid.<br/>")}}if($("#auth_user").val().length==0||$("#auth_password").val().length==0){a=false;$("#results").append("User/password can not be empty.<br/>")}return a}function getRemoteIp(){return $("#dst_addr_select").val()=="0"?$("#dst_addr_input").val():$("#dst_addr_select option:selected").text()}function getResultsRequest(a){setTimeout(function(){var b={};b.ticket=ticket;b.action="status";$.ajax({url:"sptest_action.cgi",cache:false,data:b,dataType:"json",success:handleStatus,error:handleError})},a)}function sendStopRequest(){var a={};a.ticket=ticket;a.action="stop";$.ajax({url:"sptest_action.cgi",cache:false,data:a,dataType:"json",success:function(){}})}function handleStatus(b,e){if(b.state==10){if(b.flags==0){var a=toFixed(b.tx,2);var d=toFixed(b.rx,2);$("#tx_results").html(a+" Mbps");$("#rx_results").html(d+" Mbps");var c=toFixed(parseFloat(a)+parseFloat(d),2);$("#total_results").html(""+c+" Mbps");$("#results").html("")}else{$("#results").html("Error: Speedtest timed out.")}enableForm(true);$("#loader").hide();sendStopRequest()}else{elapsed_time++;if(elapsed_time<max_time){getResultsRequest(1000)}else{$("#results").html("Error: Speedtest timed out.");enableForm(true);$("#loader").hide();sendStopRequest()}}}function handleStart(a,b){if(a.status!=0){$("#results").html("Error: "+a.message);enableForm(true);$("#loader").hide();return}$("#results").html("");$("#loader").show();max_time=parseInt($("#time_limit").val())+5;elapsed_time=0;getResultsRequest(1000)}function handleRemote(a,c){if(a==null){window.location.reload()}if(a.status!=0){$("#results").html("Error: "+a.message);enableForm(true);return}var b={};b.ticket=ticket;b.action="start";b.target=getRemoteIp();b.port=$("#launcher_port").val();b.login=$("#auth_user").val();b.passwd=$("#auth_password").val();if($("#show_adv").is(":checked")){b.duration=$("#time_limit").val();b.direction=$("#direction_select").val()}$.ajax({cache:false,url:"sptest_action.cgi",data:b,dataType:"json",success:handleStart,error:handleError})}function startTest(){if(!validateInput()){return}var a=function(){var d="";for(var c=0;c<8;++c){d+=(((1+Math.random())*65536)|0).toString(16).substring(1)}return d};ticket=Math.floor(Math.random()*1000);$("#results").html("Starting...");$("#tx_results").html("N/A");$("#rx_results").html("N/A");$("#total_results").html("N/A");enableForm(false);var b={};b.ticket=ticket;b.action="remote";b.target=getRemoteIp();b.port=$("#launcher_port").val();b.login=$("#auth_user").val();b.passwd=$("#auth_password").val();b.airosid=a();$.ajax({cache:false,url:"sptest_action.cgi",data:b,dataType:"json",success:handleRemote,error:handleError})}function handleError(b,c,a){enableForm(true);$("#loader").hide();if(b&&b.status!=200&&b.status!=0){window.location.reload()}else{$("#results").html("Error: "+c)}}function enableForm(a){$("#runtest").enable(a)}function refreshIPs(c){var a='<option value="0">specify manually</option>';var b=c.split("\n");for(i=0;i<b.length;++i){if(b[i].length>0){a+='<option value="'+i+1+'">';a+=b[i]+"</option>"}}$("#dst_addr_select").html(a);onIpChanged()}$.fn.set_visible=function(a){if(a){return this.show()}else{return this.hide()}};$.fn.enable=function(a){if(a){return this.removeClass("disabled").attr("disabled",false)}else{return this.attr("disabled",true).addClass("disabled")}};function onIpChanged(){$("#dst_addr_input").enable($("#dst_addr_select").val()==0)}function onAdvancedChanged(){var a=$("#show_adv").is(":checked");$("#advanced1").set_visible(a)}function loadIPs(){$.post("ipscan.cgi?a="+new Date().getTime(),refreshIPs)}$(document).ready(function(){$("#runtest").click(function(){startTest();return false});$("#ip_refresh").click(function(){loadIPs();return false});$("#dst_addr_select").change(onIpChanged);$("#show_adv").change(onAdvancedChanged);init()});