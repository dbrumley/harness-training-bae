var g_cfg={},views={netmode:{headerId:"#headerNetmode",init:function(){var a=this;this.cfgBackup={};$("#netmode").change(function(){var e=$(this).val(),d=g_cfg,c=g_net.evFns;$("#network").trigger("beforeSubmit");if(a.cfgBackup[e]){g_cfg=a.cfgBackup[e]}else{g_cfg=g_net.switchNetmode(e)}a.cfgBackup[d.netmode]=d;g_net=ubnt.net.network(g_cfg);g_net.evFns=c;renderViews()})},render:function(){if(g_cfg.netmode=="airfiber"){$("#headerNetmode").toggle(false).next().toggle(false);$("#netmode").parent().toggle(false);$("#headerCfgmode").toggle(false).next().toggle(false);$("#mgmtIfc").toggle(false);$("#headerMgmt").toggle(false)}}},disableNet:{init:function(){$("#network").bind("beforeSubmit",function(){var d=$("#disableNet").val(),a=(g_net.isBridge||g_net.isAirfiber)?"":g_net.wan.getDevname(),c=[];if(d=="eth0/eth1"){c=["eth0","eth1"]}else{if(d=="eth0/ath0"){c=["eth0/air0"]}else{if(d=="eth0/ath0"){c=["eth0","ath0"]}else{c.push(d)}}}g_cfg.netconf.each(function(f,e){var h=$.inArray(e.devname,c)==-1;if(h&&(g_net.isBridge||g_net.isAirfiber)&&e.up=="disabled"){var i=g_cfg.bridge.objs[0],g=i&&i.port.findByDevname(e.devname);if(g&&i.canHavePort(g.devname)){g.enabled(true)}}e.up=h?"enabled":"disabled"})})},render:function(){var f=["None"].concat(g_cfg.getInterfaces(["board"])),d=(g_net.isBridge||g_net.isAirfiber)?"":g_net.wan.getDevname(),a=g_cfg.netconf.find({status:"enabled",up:"disabled"}),h=$("#disableNet"),g="None",c=g_cfg.netmode=="soho",e=g_cfg.netmode=="airfiber";if(a.length==1){g=a[0].devname}else{if(a.length==2){if(c){g="eth0/ath0"}else{if(e){g="eth0/air0"}else{g="eth0/eth1"}}}}h.children().remove();f.sort();if(c){f.push("eth0/ath0")}else{if(e){f.push("eth0/air0")}else{if($.inArray("eth1",f)!=-1){f.push("eth0/eth1")}}}$.each(f,function(i,j){h.append($("<option></option>").prop("selected",j==g).attr("value",j).text(ubnt.cfg.devname2uidevname(ubnt.cfg.devname2uidevname(j))))})}},ifaces:{headerId:"#headerIfaces",init:function(){var a=function(g,k,j){var f=g_net.getMaxMtu(g);var i="MTU value must be in range [64-"+f+"].";var h=parseInt(k);if($.isNaN(k)||(h<64||h>f)){j.push(i);return false}return true};var c=$("#iface_table > tbody")[0],d=this,e=$("#ifaceErrDiv");$("#iface_table").delegate("input.editIface","click",function(){var f=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#ifaceEditTmpl").tmpl([f]));$("#ifaceMtu").prop("title","[64-"+g_net.getMaxMtu(f.devname)+"]");$(".editIface").disable()}).delegate("input.cancelIface","click",function(){var f=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#ifaceTmpl").tmpl([f]));d.render()}).delegate("input.saveIface","click",function(){var h=$.tmplItem(this).data;var f=$("#ifaceMtu").val();var g=[];if(a(h.devname,f,g)){g_cfg.netconf.findByDevname(h.devname,true).mtu=f;h.mtu=f;$(this).closest("tr").replaceWith($("#ifaceTmpl").tmpl([h]));d.render()}showErrors(e,g)});g_net.bind("ifcAdded ifcRemoved ifcEnabled ifcDisabled",$.proxy(this,"render"))},render:function(){var a=$.grep(g_cfg.netconf.objs,function(c){return c.enabled()});a.sort(function(d,e){var c=ubnt.cfg.devname2uidevname(d.devname);b=ubnt.cfg.devname2uidevname(e.devname);if(c==b){return 0}else{if(c<b){return -1}else{return 1}}});$("#iface_table > tbody > tr").remove();$("#ifaceTmpl").tmpl(a).appendTo("#iface_table")}},vlan:{headerId:"#headerVlan",init:function(){var a=$("#vlan_table > tbody")[0],d=$("#vlanErrDiv"),c=this;$("#vlan_table").delegate("input.enableVlan","change",function(){var e=$.tmplItem(this).data,f=this.checked;e.enabled(f);g_net.enableIfc(e.getFullDevname(),f)}).delegate("input.editVlan","click",function(){$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",true);var e=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#vlanEditTmpl").tmpl([e]));c.ifcChanged()}).delegate("input.saveVlan","click",function(){var e=$.tmplItem(this).data;e.comment=$("#edtVlanComment").val();$(this).closest("tr").replaceWith($("#vlanTmpl").tmpl([e]));$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",false);c.ifcChanged()}).delegate("input.delVlan","click",function(){var e=$.tmplItem(this).data;g_net.removeVlan(e);if($(this).closest("tr").find("#edtVlanComment").length>0){$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",false)}$(this).closest("tr").remove();$("#vlan_table").trigger("vlanDel",e.getFullDevname())});$("#vlanAdd").click(function(){var f=g_cfg.get("vlan"),e=f.create($("#vlanIfc").val(),$("#vlanId").val(),$("#vlanComment").val(),true),g=[];if(e.valid(g)){if(f.find({devname:e.devname,id:e.id}).length){g.push("VLAN already exist.")}else{g_net.addVlan(e);$("#vlan_table tfoot input[type=text]").val("");$("#vlanTmpl").tmpl(e).appendTo("#vlan_table");$("#vlan_table").trigger("vlanAdd",e.getFullDevname())}}showErrors(d,g)});g_net.bind("ifcUsed",this.ifcChanged).bind("ifcUnused",this.ifcChanged)},render:function(){var a=g_cfg.get("vlan");$("#vlanIfc").children().remove();$.each(g_cfg.getInterfaces(["board"]),function(c,d){$("#vlanIfc").append($("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d)))});$("#vlan_table > tbody > tr").remove();$("#vlanTmpl").tmpl(a.objs).appendTo("#vlan_table");this.ifcChanged()},ifcChanged:function(){$("#vlan_table > tbody > tr").each(function(c){var e=$(this),a=e.tmplItem().data.getFullDevname(),d=$.inArray(a,g_net.freeIfc)==-1;e.find("input.enableVlan").prop("disabled",d);e.find("input.delVlan").prop("disabled",d)})}},bridge:{headerId:"#headerBridge",init:function(){var a=this;$("#bridgeAdd").click(function(){var c=g_net.addBridge();$("#bridgeTmpl").tmpl(c).appendTo("#bridge_table");a.updateAddBridgePortSelect();$("#bridge_table").trigger("bridgeAdd",c.getDevname())});$("#bridge_table").delegate("input.enableBridge","change",function(){var c=$.tmplItem(this).data,d=this.checked;c.enabled(d);g_net.enableIfc(c.devname,d)}).delegate("input.enableBridgeStp","change",function(){var c=$.tmplItem(this).data;c.stp.enabled(this.checked)}).delegate("input.delBridge","click",function(){var c=$.tmplItem(this).data;g_net.removeBridge(c);$(this).closest("tr").remove();a.updateAddBridgePortSelect()}).delegate("select.addBridgePort","change",function(){var d=$(this).val(),c=$.tmplItem(this).data;if(d=="add"){return}if(g_net.addBridgePort(c,d)!=null){$(this).siblings("select.bridgePortList").append($("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d)));$(this).val("add");a.updateAddBridgePortSelect()}}).delegate("input.delBridgePort","click",function(){var c=$.tmplItem(this).data,d=$(this).siblings("select.bridgePortList").children("option:selected");d.each(function(e,f){g_net.removeBridgePort(c,f.value)});d.remove();a.updateAddBridgePortSelect()});g_net.bind("ifcUnused",function(d,c){a.updateAddBridgePortSelect()}).bind("ifcUsed",function(d,c){});g_net.bind("ifcUsed ifcUnused",this.ifcChanged).bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",this.updateAddBridgePortSelect);$("#network").bind("beforeSubmit",function(){if(!a.active){return}$("#bridge_table .comment").each(function(){var c=$.tmplItem(this).data;c.comment=$(this).val()})})},render:function(){$("#bridge_table > tbody > tr").remove();$("#bridgeTmpl").tmpl(g_cfg.bridge.objs).appendTo("#bridge_table");this.updateAddBridgePortSelect();this.ifcChanged()},valid:function(){var a=[];g_cfg.bridge.each(function(d,c){if(c.port.objs.length==0){a.push(ubnt.cfg.devname2uidevname(c.devname)+" can not be empty.")}});showErrors($("#bridgeErrDiv"),a);return(a.length==0)},updateAddBridgePortSelect:function(){var a=g_net.availableIfcsForBridgePors();$("#bridge_table select.addBridgePort").each(function(){var c=$.tmplItem(this).data,e=$.grep(a,$.proxy(c,"canHavePort")).sort(),d=$(this);d.children('option[value!="add"]').remove();$.each(filterEnabledIfcs(e),function(f,g){d.append($("<option></option>").attr("value",g).text(ubnt.cfg.devname2uidevname(g)))})})},ifcChanged:function(){$("#bridge_table > tbody > tr").each(function(a){var e=$(this),c=e.tmplItem().data.getDevname(),d=$.inArray(c,g_net.freeIfc)==-1;e.find("input.enableBridge").prop("disabled",d);e.find("input.delBridge").prop("disabled",d)})}},firewall:{headerId:"#headerFirewall",getTable:function(){return(g_cfg.netmode!="bridge"&&g_cfg.netmode!="airfiber")?"iptables":"ebtables"},getFw:function(a){return g_cfg[a]?g_cfg[a]:g_cfg.get(a)},init:function(){var d=this,e=$("#fwErrDiv");var c=function(f){if(f&&f.indexOf("/")==-1){f+=f==="0.0.0.0"?"/0":"/32"}return f},a=function(g,f){var h={devname:$("#"+g+"Ifc").val(),proto:"0x0800",ipProto:$("#"+g+"Proto").val(),src:c($("#"+g+"SrcIp").val()),sport:$("#"+g+"SrcPort").val(),dst:c($("#"+g+"DstIp").val()),dport:$("#"+g+"DstPort").val(),src_inv:$("#"+g+"NotSrcIp").prop("checked"),sport_inv:$("#"+g+"NotSrcPort").prop("checked"),dst_inv:$("#"+g+"NotDstIp").prop("checked"),dport_inv:$("#"+g+"NotDstPort").prop("checked"),target:$("#"+g+"Target").val(),comment:$("#"+g+"Comment").val(),enabled:f};return h};$("#fw_table").delegate("input.delFwRule","click",function(){var g=$.tmplItem(this).data;d.fw.remove(g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).remove();if(f.find("#fweTarget").length>0){$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e)}).delegate("input.editFwRule","click",function(){$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",true);var g=$.tmplItem(this).data;var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwEditRuleTmpl").tmpl([g]));$("#fweTarget").val(g._target);d.fillIfc($("#fweIfc"));$("#fweIfc").val(g._devname);$("#fweProto").val(g._ipProto);$("#fweProto").change(function(){$(".fwe_port").disable($(this).val()<2)}).change()}).delegate("input.saveFwRule","click",function(){var i=$.tmplItem(this).data;var g=d.fw.create(a("fwe",i.enabled));var h=[];if(g.valid(h)){d.fw.replace(i,g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwRuleTmpl").tmpl([g]));$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e,h)}).delegate("input.enableFwRule","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#fwRuleAdd").click(function(){var f=d.fw.create(a("fw",true));var g=[];if(f.valid(g)){d.fw.add(f);$("#fwRuleTmpl").tmpl(f).appendTo("#fw_table");$("#fw_table tfoot input[type=text]").val("");$("#fw_table tfoot input[type=checkbox]").prop("checked",false);$("#fw_table tfoot select option:first-child").prop("selected",true)}showErrors(e,g)});$("#fwProto").change(function(){$(".fw_port").disable($(this).val()<2)}).change();$("#fwEnable").change(function(){var f=this.checked;g_cfg.get(d.table+".sys.fw").enabled(f);if(f){g_cfg.get(d.table+".sys").enabled(true);g_cfg.get(d.table).enabled(true)}$("#fw_table").toggle(f)});g_net.bind("ifcAdded ifcRemoved ipModeChanged",$.proxy(this,"ifcChanged"))},render:function(){this.table=this.getTable();this.fw=this.getFw(this.table);var a=g_cfg.get(this.table+".sys.fw").enabled();$("#fw_table > tbody > tr").remove();$("#fwEnable").prop("checked",a);$("#fw_table").toggle(a);this.ifcChanged();if(this.fw){$("#fwRuleTmpl").tmpl(this.fw.objs).appendTo("#fw_table")}},fillIfc:function(c){var a=(g_net.isBridge||g_net.isAirfiber)?g_cfg.bridge.getInterfaces():g_cfg.bridge.getPorts();c.children().remove();c.append($("<option></option>").attr("value","").text("ANY"));$.each(g_net.interfaces,function(d,e){if($.inArray(e,a)==-1){c.append($("<option></option>").attr("value",e).text(ubnt.cfg.devname2uidevname(e)))}});if(!g_net.isBridge&&!g_net.isAirfiber&&g_net.wan.getIpMode()=="Pppoe"){c.append($("<option></option>").attr("value","ppp+").text(ubnt.cfg.devname2uidevname("ppp+")))}},ifcChanged:function(){this.fillIfc($("#fwIfc"))}},routes:{headerId:"#headerRoutes",init:function(){var c=$("#routeErrDiv"),a=this;$("#route_table").delegate("input.delRoute","click",function(){var d=$.tmplItem(this).data;g_cfg.route.remove(d);if($(this).closest("tr").find("#edtIp").length>0){$("#route_table").find(".editRoute, #routeAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(c)}).delegate("input.editRoute","click",function(){$("#route_table").find(".editRoute, #routeAdd").prop("disabled",true);var d=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#routeTmplEdit").tmpl([d]))}).delegate("input.saveRoute","click",function(){var e=$.tmplItem(this).data;var d=g_cfg.route.create($("#edtIp").val(),$("#edtNetmask").val(),$("#edtGateway").val(),$("#edtComment").val(),e.enabled);var f=[];if(d.valid(f)){g_cfg.route.replace(e,d);$(this).closest("tr").replaceWith($("#routeTmpl").tmpl([d]));$("#route_table").find(".editRoute, #routeAdd").prop("disabled",false)}showErrors(c,f)}).delegate("input.enableRoute","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#routeAdd").click(function(){var d=g_cfg.route.create($("#rtIp").val(),$("#rtNetmask").val(),$("#rtGateway").val(),$("#rtComment").val(),true);var e=[];if(d.valid(e)){g_cfg.route.add(d);$("#route_table tfoot input[type=text]").val("");$("#routeTmpl").tmpl(d).appendTo("#route_table")}showErrors(c,e)});$("#network").bind("beforeSubmit",function(){if(!a.active){return}if(g_cfg.route.objs.length>1){g_cfg.route.enabled(true)}})},render:function(){var a=g_cfg.route;$("#route_table > tbody > tr").remove();if(a){$("#routeTmpl").tmpl(a.objs.slice(1)).appendTo("#route_table")}}},portForward:{headerId:"#headerPortFwd",init:function(){var c=this,d=$("#pfwdErrDiv");var a=function(e){if(e&&e.indexOf("/")==-1){e+=e==="0.0.0.0"?"/0":"/32"}return e};$("#pfwd_table").delegate("input.delPortFwd","click",function(){var e=$.tmplItem(this).data;if($(this).closest("tr").find("#edtHost").length>0){$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",false)}c.portfw.remove(e);$(this).closest("tr").remove();showErrors(d)}).delegate("input.editPortFwd","click",function(){$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",true);var e=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#portFwdTmplEdit").tmpl([e]))}).delegate("input.savePortFwd","click",function(){var e=$.tmplItem(this).data,f=c.portfw.create(g_net.wan.getDevname(),$("#edtHost").val(),$("#edtPort").val(),$("#edtProto").val(),a($("#edtSrc").val()),a($("#edtDst").val()),$("#edtDport").val(),$("#edtComment").val(),e.enabled());var g=[];if(f.valid(g)){c.portfw.replace(e,f);$(this).closest("tr").replaceWith($("#portFwdTmpl").tmpl([f]));$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",false)}showErrors(d,g)}).delegate("input.enablePortFwd","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#pfwdAdd").click(function(){var e=c.portfw.create(g_net.wan.getDevname(),$("#pfwdHost").val(),$("#pfwdPort").val(),$("#pfwdProto").val(),a($("#pfwdSrc").val()),a($("#pfwdDst").val()),$("#pfwdDport").val(),$("#pfwdComment").val(),true);var f=[];if(e.valid(f)){c.portfw.add(e);$("#pfwd_table tfoot input[type=text]").val("");$("#portFwdTmpl").tmpl(e).appendTo("#pfwd_table")}showErrors(d,f)});$("#network").bind("beforeSubmit",function(){if(!c.active){return}g_cfg.get("iptables").enabled(true);g_cfg.get("iptables.sys").enabled(true);if(c.portfw.enabled(c.portfw.objs.length>0)){var e=g_net.wan.getNatDevname();c.portfw.each(function(f,g){g.devname=e})}})},render:function(){this.portfw=g_cfg.get("iptables.sys.portfw");$("#pfwd_table > tbody > tr").remove();$("#portFwdTmpl").tmpl(this.portfw.objs).appendTo("#pfwd_table")}},aliases:{headerId:"#headerAliases",init:function(){var a=$("#aliasErrDiv");$("#alias_table").delegate("input.delAlias","click",function(){var d=$.tmplItem(this).data,c=g_cfg.netconf.findByDevname(d.devname,true);c.alias.remove(d.aliasObjRef);if($(this).closest("tr").find("#edtAliasIp").length>0){$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(a)}).delegate("input.editAlias","click",function(){$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",true);var c=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#aliasEditTmpl").tmpl([c]))}).delegate("input.saveAlias","click",function(){var e=$.tmplItem(this).data,g=e.aliasObjRef,d=g_cfg.netconf.findByDevname(e.devname,true);var c=d.alias.create($("#edtAliasIp").val(),$("#edtAliasNetmask").val(),$("#edtAliasComment").val(),g.enabled());var f=[];if(c.valid(f)){d.alias.replace(g,c);e.aliasObjRef=c;$(this).closest("tr").replaceWith($("#aliasTmpl").tmpl([e]));$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",false)}showErrors(a,f)}).delegate("input.enableAlias","change",function(){$.tmplItem(this).data.aliasObjRef.enabled(this.checked)});$("#aliasAdd").click(function(){var c=g_cfg.netconf.findByDevname($("#aliasIfc").val(),true);if(c){var d={devname:c.devname,aliasObjRef:c.alias.create($("#aliasIp").val(),$("#aliasNetmask").val(),$("#aliasComment").val(),true)};var e=[];if(d.aliasObjRef.valid(e)){c.alias.add(d.aliasObjRef);$("#alias_table tfoot input[type=text]").val("");$("#aliasTmpl").tmpl(d).appendTo("#alias_table")}showErrors(a,e)}});g_net.bind("ifcUsed",$.proxy(this,"render")).bind("ifcUnused",this.fillDevnames)},render:function(){$("#alias_table > tbody").empty();this.fillDevnames();$("#aliasTmpl").tmpl(g_net.getIpAliases()).appendTo("#alias_table")},fillDevnames:function(){var c=g_cfg.bridge?g_cfg.bridge.getPorts():[],a=$.grep(g_net.interfaces,function(d){return $.inArray(d,c)==-1});$("#aliasIfc").children().remove();$.each(a,function(d,e){$("#aliasIfc").append($("<option></option>").attr("value",e).text(ubnt.cfg.devname2uidevname(e)))})}},wan:{headerId:"#headerWan",init:function(){var a=$("#wanIfc"),c=this;g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",$.proxy(this,"updateWanIfc"));g_net.bind("bridgePortAdded bridgePortRemoved",$.proxy(this,"updateMaxMtuTooltip"));$("[name=wanIpMode]").click(function(){var d=$(this).val();$("#wanSettings .initial_hide").hide();$("#wan"+d).show();g_net.wan.setIpMode(d,true);c.fillData(g_net.wan);g_net.trigger("ipModeChanged")});a.change(function(){var d=$(this).val();if(!g_net.advancedCfgMode()&&g_cfg.netmode=="router"){if(d!=g_net.wan.getDevname()){g_net.swapWanLanIfcs(d)}}else{g_net.setWanIfc($(this).val())}c.updateMaxMtuTooltip();c.updateChangeMac()});$("#wanNat").click(function(){$("#wanNatProtocols").toggle(this.checked)});$("#wanDmz").click(function(){$("#wanDmzSection").toggle(this.checked)});$("#wanChangeMac").click(function(){$("#wanChangeMacSection").toggle(this.checked)});$("#network").bind("beforeSubmit",function(){if(!c.active){return}var h=$("#wanSettings input:radio[name=wanIpMode]:checked").val(),g=g_net.wan,f=$("#wanNat").prop("checked"),i=$("#wanDmz").prop("checked"),d=$("#wanBlockMgmt").prop("checked"),e=$("#wanChangeMac").prop("checked");g.setIpMode(h,true);switch(h){case"Static":g.setIp($("#wanIpAddr").val(),$("#wanIpNetmask").val());g.setGateway($("#wanGateway").val());g.setDns(0,$("#wanDns1").val());g.setDns(1,$("#wanDns2").val());break;case"Dhcpc":g.setDhcpcFallback($("#wanDhcpcFallbackIp").val(),$("#wanDhcpcFallbackNetmask").val());break;case"Pppoe":g.setPppoe({name:$("#wanPppoeUser").val(),password:$("#wanPppoePassw").val(),pppoe_service:$("#wanPppoeService").val(),fallback:$("#wanPppoeFallbackIp").val(),fallback_netmask:$("#wanPppoeFallbackNetmask").val(),mtu:$("#wanPppoeMtu").val(),mru:$("#wanPppoeMru").val(),require:{mppe128:$("#wanPppoeEncryption").prop("checked")?"enabled":"disabled"}});break}if(!g_net.advancedCfgMode()){g.setMtu($("#wanMtu").val())}g.natEnabled(f);if(f){g.natProtocolEnabled("sip",$("#wanNatSip").prop("checked"));g.natProtocolEnabled("pptp",$("#wanNatPptp").prop("checked"));g.natProtocolEnabled("ftp",$("#wanNatFtp").prop("checked"));g.natProtocolEnabled("rtsp",$("#wanNatRtsp").prop("checked"))}g.dmzEnabled(i);if(i){g.dmzObj.host=$("#wanDmzIp").val();g.dmzMgmtPortsEnabled($("#wanDmzMgmt").prop("checked"))}g.blockMgmt(d);g.netconfObj.hwaddr.enabled(e);if(e){g.netconfObj.hwaddr.mac=($("#wanMac").val())}g.netconfObj.autoip.enabled($("#wanAutoIp").prop("checked"))})},render:function(){var a=g_net.advancedCfgMode();if(a||g_cfg.netmode=="router"){$("#wanIfcSection").show();this.updateWanIfc()}else{$("#wanIfcSection").hide()}$("input:radio[name=wanIpMode]").filter('[value="'+g_net.wan.getIpMode()+'"]').click();this.updateMaxMtuTooltip()},valid:function(){var c=[],a=$("#wanSettings");ipMode=$("#wanSettings input:radio[name=wanIpMode]:checked").val(),dmzEnabled=$("#wanDmz").prop("checked"),changeMacEnabled=$("#wanChangeMac").prop("checked"),maxMtu=g_net.wan.getMaxMtu();switch(ipMode){case"Static":validateFields(a,[{name:"WAN IP",field:"#wanIpAddr",req:true,valid:_validateNonZeroIP},{name:"WAN Netmask",field:"#wanIpNetmask",req:true,valid:_validateNetmask},{name:"WAN Gateway IP",field:"#wanGateway",req:true,valid:_validateNonZeroIP},{name:"Primary DNS IP",field:"#wanDns1",req:true,valid:_validateNonZeroIP},{name:"Secondary DNS IP",field:"#wanDns2",req:false,valid:_validateNonZeroIP},{name:"MTU",field:"#wanMtu",req:true,min:64,max:maxMtu}],c);break;case"Dhcpc":validateFields(a,[{name:"DHCP Fallback IP",field:"#wanDhcpcFallbackIp",req:true,valid:_validateNonZeroIP},{name:"DHCP Fallback Netmask",field:"#wanDhcpcFallbackNetmask",req:true,valid:_validateNetmask},{name:"MTU",field:"#wanMtu",req:true,min:64,max:maxMtu}],c);break;case"Pppoe":validateFields(a,[{name:"PPPoE Fallback IP",field:"#wanPppoeFallbackIp",req:false,valid:_validateNonZeroIP},{name:"PPPoE Fallback Netmask",field:"#wanPppoeFallbackNetmask",req:false,valid:_validateNetmask},{name:"PPPoE MTU",field:"#wanPppoeMtu",req:true,min:64,max:maxMtu},{name:"PPPoE MRU",field:"#wanPppoeMru",req:true,min:64,max:maxMtu}],c);break}if(dmzEnabled){validateFields(a,[{name:"DMZ IP",field:"#wanDmzIp",req:true,valid:_validateNonZeroIP}],c)}if(changeMacEnabled){validateFields(a,[{name:"MAC Address",field:"#wanMac",req:true,valid:function(d){return/^([0-9A-F]{2}:?){5}[0-9A-F]{2}$/i.test(d)&&!/^(F{2}:?){5}F{2}$/i.test(d)}}],c)}showErrors(a.find(".errors"),c);return(c.length==0)},fillData:function(a){$("#wanIpAddr").val(a.netconfObj.ip);$("#wanIpNetmask").val(a.netconfObj.netmask);$("#wanGateway").val(a.getGateway());$("#wanDns1").val(a.getDns(0));$("#wanDns2").val(a.getDns(1));$("#wanDhcpcFallbackIp").val(a.getDhcpcFallback());$("#wanDhcpcFallbackNetmask").val(a.getDhcpcFallbackNetmask());$("#wanPppoeUser").val(a.getPppoe("name"));$("#wanPppoePassw").val(a.getPppoe("password"));$("#wanPppoeService").val(a.getPppoe("pppoe_service"));$("#wanPppoeFallbackIp").val(a.getPppoe("fallback"));$("#wanPppoeFallbackNetmask").val(a.getPppoe("fallback_netmask"));$("#wanPppoeMtu").val(a.getPppoe("mtu"));$("#wanPppoeMru").val(a.getPppoe("mru"));$("#wanPppoeEncryption").prop("checked",a.pppObj&&a.pppObj.require&&a.pppObj.require.mppe128?a.pppObj.require.mppe128=="enabled":false);$("#wanMtuSection").toggle(a.ipMode!="Pppoe"&&!g_net.advancedCfgMode());$("#wanMtu").val(a.netconfObj.mtu);$("#wanNat").prop("checked",a.natEnabled());$("#wanNatProtocols").toggle(a.natEnabled());$("#wanNatSip").prop("checked",a.natProtocolEnabled("sip"));$("#wanNatPptp").prop("checked",a.natProtocolEnabled("pptp"));$("#wanNatFtp").prop("checked",a.natProtocolEnabled("ftp"));$("#wanNatRtsp").prop("checked",a.natProtocolEnabled("rtsp"));$("#wanAutoIp").prop("checked",a.netconfObj.autoip.enabled());$("#wanDmz").prop("checked",a.dmzEnabled());$("#wanDmzSection").toggle(a.dmzEnabled());$("#wanDmzMgmt").prop("checked",a.dmzMgmtPortsEnabled());$("#wanDmzIp").val(a.dmzObj&&a.dmzObj.host?a.dmzObj.host:"");$("#wanBlockMgmt").prop("checked",a.blockMgmt());this.updateChangeMac()},updateWanIfc:function(){if(!this.active){return}var a=g_net.wan.getDevname(),e=g_net.mlan.getDevname(),d=!g_net.advancedCfgMode()&&g_cfg.netmode=="router",g=d?[]:Array.prototype.slice.call(g_net.freeIfc,0),f=$("#wanIfc");g.push(a);if(d){for(var c in g_net.lan){if(g_net.lan.hasOwnProperty(c)){g.push(c)}}}else{if(a!=e){g.push(e)}}g.sort();f.children().remove();$.each(filterEnabledIfcs(g),function(h,i){var j=$("<option></option>").attr("value",i).text(ubnt.cfg.devname2uidevname(i));if(i==a){j.prop("selected",true)}f.append(j)})},updateMaxMtuTooltip:function(){if(!this.active){return}$("#wanMtu").prop("title","[64-"+g_net.wan.getMaxMtu()+"]")},isBridgeSelected:function(){return g_net.wan.getDevname().indexOf("br")==0},updateChangeMac:function(){var a=this.isBridgeSelected(),c=g_net.wan;$("#wanChangeMac").prop("disabled",a);$("#wanChangeMac").prop("checked",c.netconfObj.hwaddr.enabled()&&!a);$("#wanChangeMacSection").toggle(c.netconfObj.hwaddr.enabled()&&!a);$("#wanMac").val(c.netconfObj.hwaddr&&c.netconfObj.hwaddr.mac?c.netconfObj.hwaddr.mac:"")}},lan:{headerId:"#headerLan",init:function(){var a=$("#lanIfc"),c=this;$("#lanAdd").click(function(){var f=$(this).siblings("#lanIfc"),e=f.val(),d=g_net.addLan(e);if(d){c.updateLanIfc();$("#lanTmpl").tmpl(d,c.tmplFuncs).appendTo("#lanSettings").find('input:radio[value="'+d.getDhcpServer()+'"]').click();c.updateMaxMtuTooltip()}});$("#lanSettings").delegate(".delLan","click",function(){var d=$.tmplItem(this).data;g_net.removeLan(d.getDevname());$(this).closest(".lanFields").remove();c.updateLanIfc()}).delegate(".lanDhcp","click",function(){var g=$(this),f=g.val(),e=g.closest(".lanFields"),d=g.tmplItem().data;e.find(".initial_hide").hide();e.find(".lanDhcp"+f).show();d.setDhcpServer(f);c.fillDhcp(e,d)}).delegate(".lanDhcpDnsProxy","click",function(){var d=$(this);d.parent().next().toggle(!this.checked)});g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",$.proxy(this,"updateLanIfc")).bind("bridgePortAdded bridgePortRemoved",$.proxy(this,"updateMaxMtuTooltip")).bind("wanIfcChanged",$.proxy(this,"render"));$("#network").bind("beforeSubmit",function(){if(!c.active){return}var d=$("#lanSettings").find(".lanFields");d.each(function(){var h=$(this),g=h.tmplItem().data;g.setIp(h.find(".lanIpAddr").val(),h.find(".lanIpNetmask").val());if(!g_net.advancedCfgMode()){g.setMtu(h.find(".lanMtu").val())}g.upnpdEnabled(h.find(".lanUPnP").prop("checked"));switch(g.getDhcpServer()){case"Enabled":var f=h.find(".lanDhcpDnsProxy").prop("checked"),e=g.dhcpdObj.dns;g.dhcpdObj.start=h.find(".lanDhcpStart").val();g.dhcpdObj.end=h.find(".lanDhcpEnd").val();g.dhcpdObj.netmask=h.find(".lanDhcpNetmask").val();g.dhcpdObj.lease_time=h.find(".lanDhcpLeaseTime").val();g.dhcpdObj.dnsproxy=f?"enabled":"disabled";e.objs[0].status=e.objs[1].status=f?"disabled":"enabled";if(!f){e.objs[0].server=h.find(".lanDhcpDns1").val();e.objs[1].server=h.find(".lanDhcpDns2").val()}break;case"Relay":g.dhcpRelayServerObj.devname=g_net.wan.getDevname();g.dhcpRelayServerObj.ip=h.find(".lanDhcpSrvIp").val();g.dhcpRelayClientObj.agentid=h.find(".lanDhcpAgent").val();break}})})},render:function(){var d=$("#lanSettings"),c=g_net.advancedCfgMode(),a=g_cfg.netmode=="router",f=[];this.updateLanIfc();d.children().remove();for(var e in g_net.lan){if(g_net.lan[e].enabled()){f.push(g_net.lan[e])}}$("#lanTmpl").tmpl(f,this.tmplFuncs).appendTo(d);d.find(".lanFields").each(function(){var h=$(this),g=h.tmplItem().data;h.find('input:radio[value="'+g.getDhcpServer()+'"]').click()}).find(".lanIfcSection").toggle(c||a).find(".delLan").toggle(c);this.updateMaxMtuTooltip();$("#addLanSection").toggle(c)},valid:function(){var c=$("#lanSettings").find(".lanFields"),a=true;c.each(function(){var g=[],f=$(this),e=f.tmplItem().data,h=e.getMaxMtu();validateFields(f,[{name:"LAN IP address",field:".lanIpAddr",req:true,valid:_validateNonZeroIP},{name:"LAN Netmask",field:".lanIpNetmask",req:true,valid:_validateNetmask},{name:"LAN MTU",field:".lanMtu",req:true,min:64,max:h}],g);switch(e.getDhcpServer()){case"Enabled":var d=f.find(".lanDhcpDnsProxy").prop("checked");validateFields(f,[{name:"DHCP Range Start",field:".lanDhcpStart",req:true,valid:_validateNonZeroIP},{name:"DHCP Range End",field:".lanDhcpEnd",req:true,valid:_validateNonZeroIP},{name:"DHCP Netmask",field:".lanDhcpNetmask",req:true,valid:_validateNetmask},{name:"DHCP Lease Time",field:".lanDhcpLeaseTime",req:true,min:120,max:172800}],g);if(!d){validateFields(f,[{name:"DHCP Primary DNS IP",field:".lanDhcpDns1",req:false,valid:_validateNonZeroIP},{name:"DHCP Secondary DNS IP",field:".lanDhcpDns2",req:false,valid:_validateNonZeroIP}],g)}break;case"Relay":validateFields(f,[{name:"DHCP Server",field:".lanDhcpSrvIp",req:true,valid:_validateNonZeroIP}],g);break}showErrors(f.find(".errors"),g);a=a&&(g.length==0)});return a},fillDhcp:function(e,d){var c=d.getDhcpdAttr("dnsproxy")=="enabled";e.find(".lanDhcpStart").val(d.getDhcpdAttr("start"));e.find(".lanDhcpEnd").val(d.getDhcpdAttr("end"));e.find(".lanDhcpNetmask").val(d.getDhcpdAttr("netmask"));e.find(".lanDhcpLeaseTime").val(d.getDhcpdAttr("lease_time"));e.find(".lanDhcpDnsProxy").prop("checked",c);e.find(".lanDhcpDnsSection").toggle(!c);if(d.dhcpdObj&&d.dhcpdObj.dns){var a=d.dhcpdObj.dns;if(a&&a.objs.length>0){e.find(".lanDhcpDns1").val(a.objs[0].server)}if(a&&a.objs.length>1){e.find(".lanDhcpDns2").val(a.objs[1].server)}}if(d.dhcpRelayServerObj){e.find(".lanDhcpSrvIp").val(d.dhcpRelayServerObj.ip)}if(d.dhcpRelayClientObj){e.find(".lanDhcpAgent").val(d.dhcpRelayClientObj.agentid)}},updateLanIfc:function(){if(!this.active){return}var a=$("#lanIfc");a.children().remove();$.each(filterEnabledIfcs(g_net.freeIfc),function(c,d){var e=$("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d));a.append(e)});a.prop("disabled",g_net.freeIfc.length==0);$("#lanAdd").prop("disabled",g_net.freeIfc.length==0)},tmplFuncs:{genId:function(a){return a+this.data.netconfObj.getIdx()}},updateMaxMtuTooltip:function(){if(!this.active){return}var a=$("#lanSettings").find(".lanFields");a.each(function(){var d=$(this),c=d.tmplItem().data;$(".lanMtu").prop("title","[64-"+c.getMaxMtu()+"]")})}},mlan:{headerId:"#headerMgmt",init:function(){var a=$("#mgmtIfc"),c=this;g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",this.updateMlanIfc);$("[name=mgmtIpMode]").click(function(){$("#mgmtStatic").hide();$("#mgmtDhcpc").hide();$("#mgmt"+$(this).val()).show()});a.change(function(){g_net.setMlanIfc($(this).val());c.render()});$("#mgmtVlanEnable").click(function(){$("#mgmtVlanIdSection").toggle(this.checked)});g_net.bind("wanIfcChanged",function(){a.change()});$("#network").bind("beforeSubmit",function(){if(g_net.mlan.enabled()){var e=$("#mgmtSettings input:radio[name=mgmtIpMode]:checked").val(),f=g_net.mlan,d=(g_net.isBridge||g_net.isAirfiber);f.setIpMode(e,d);if(e=="Static"){f.setIp($("#mgmtIpAddr").val(),$("#mgmtIpNetmask").val());if(g_net.isBridge||g_net.isAirfiber){f.setGateway($("#mgmtGateway").val());f.setDns(0,$("#mgmtDns1").val());f.setDns(1,$("#mgmtDns2").val())}}else{if(e=="Dhcpc"){f.setDhcpcFallback($("#mgmtDhcpcFallbackIp").val(),$("#mgmtDhcpcFallbackNetmask").val())}}f.netconfObj.autoip.enabled($("#mgmtAutoIp").prop("checked"));g_net.setMgmtVlan($("#mgmtVlanEnable").prop("checked")?$("#mgmtVlanId").val():"");f.setInBandManagementEnabled($("#mgmtInBandManagement").prop("checked"))}})},render:function(){var a=g_net.advancedCfgMode(),c=g_net.mlan.enabled();$("#mgmtIfcSection").toggle(false);if(a){this.updateMlanIfc()}$("#mgmtDetails").toggle(c);if(c){this.fillData(g_net.mlan)}},valid:function(){if(!g_net.mlan.enabled()){return true}var d=[],c=$("#mgmtSettings"),a=$("#mgmtSettings input:radio[name=mgmtIpMode]:checked").val(),e=g_net.mlan.getMaxMtu();if(!g_net.advancedCfgMode()&&$("#mgmtVlanEnable").prop("checked")){g_cfg.get("vlan").create("eth0",$("#mgmtVlanId").val(),"").valid(d)}if(a=="Static"){validateFields(c,[{name:"IP address",field:"#mgmtIpAddr",req:true,valid:_validateNonZeroIP},{name:"IP Netmask",field:"#mgmtIpNetmask",req:true,valid:_validateNetmask}],d);if(g_net.isBridge||g_net.isAirfiber){validateFields(c,[{name:"Gateway IP",field:"#mgmtGateway",req:true,valid:_validateNonZeroIP},{name:"Primary DNS IP",field:"#mgmtDns1",req:false,valid:_validateNonZeroIP},{name:"Secondary DNS IP",field:"#mgmtDns2",req:false,valid:_validateNonZeroIP}],d)}}else{if(a=="Dhcpc"){validateFields(c,[{name:"DHCP Fallback IP",field:"#mgmtDhcpcFallbackIp",req:true,valid:_validateNonZeroIP},{name:"DHCP Fallback Netmask",field:"#mgmtDhcpcFallbackNetmask",req:true,valid:_validateNetmask}],d)}}validateFields(c,[],d);showErrors(c.find(".errors"),d);return(d.length==0)},fillData:function(e){var d=e.getIpMode(),c=g_net.advancedCfgMode();$("input:radio[name=mgmtIpMode]").filter('[value="'+d+'"]').click();$("#mgmtVlanSection").toggle(!c);if(!c){var a=g_net.getMgmtVlan();$("#mgmtVlanEnable").prop("checked",!!a);$("#mgmtVlanIdSection").toggle(!!a);$("#mgmtVlanId").val(a)}$("#mgmtIpAddr").val(e.netconfObj.ip);$("#mgmtIpNetmask").val(e.netconfObj.netmask);if(g_net.isBridge||g_net.isAirfiber){$("#mgmtGateway").val(e.getGateway());$("#mgmtDns1").val(e.getDns(0));$("#mgmtDns2").val(e.getDns(1))}$("#mgmtGatewayDns").toggle(g_net.isBridge||g_net.isAirfiber);$("#mgmtDhcpcFallbackIp").val(e.getDhcpcFallback());$("#mgmtDhcpcFallbackNetmask").val(e.getDhcpcFallbackNetmask());$("#mgmtInBandManagement").prop("checked",e.getInbandManagementEnabled());$("#mgmtAutoIp").prop("checked",e.netconfObj.autoip.enabled())},updateMlanIfc:function(){var c=$("#mgmtIfc"),d=g_net.mlan.getDevname(),a=(!g_net.isBridge&&!g_net.isAirfiber)?g_net.wan.getDevname():d,e=Array.prototype.slice.call(g_net.freeIfc,0);e.push(d);if(a!=d){e.push(a)}e.sort();c.children().remove();$.each(filterEnabledIfcs(e),function(f,g){var h=$("<option></option>").attr("value",g).text(ubnt.cfg.devname2uidevname(g));if(g==d){h.prop("selected",true)}c.append(h)})}},igmp:{headerId:"#headerIgmp",init:function(){var a=this;$("#igmpEnable").change(function(){var c=g_cfg.igmpproxy;c.enabled(this.checked);if(c.upstream.devname===undefined){c.upstream.devname=g_net.wan.getDevname()}a.render()});$("#igmpUpstream").change(function(){g_cfg.igmpproxy.upstream.devname=$(this).val();a.updateIfcDropdowns()});$("#igmpDownstreamAdd").change(function(){var c=$(this).val();if(c=="add"){return}g_cfg.igmpproxy.add(g_cfg.igmpproxy.create(c,true));$("#igmpDownstream").append($("<option></option>").attr("value",c).text(ubnt.cfg.devname2uidevname(c)));$(this).val("add");a.updateIfcDropdowns()});$("#igmpDownstreamDel").click(function(){var c=$("#igmpDownstream").children("option:selected");devnames=[];c.each(function(d,e){devnames.push(e.value)});c.remove();a.removeDownstream(devnames);a.updateIfcDropdowns()});g_net.bind("ifcRemoved",function(c){if(c===g_cfg.get("igmpproxy.upstream").devname){g_cfg.igmpproxy.enabled(false)}else{a.removeDownstream([c])}a.render()}).bind("ifcUsed ifcUnused ifcAdded ifcRemoved",$.proxy(this,"updateIfcDropdowns"))},render:function(){var c=g_cfg.get("igmpproxy"),a=c.enabled();$("#igmpEnable").prop("checked",a);$("#igmpSettings").toggle(a);if(a){var d=$("#igmpDownstream");this.updateIfcDropdowns();d.children().remove();$.each(this.getDownstreamIfcs(),function(e,f){$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f)).appendTo(d)})}},getDownstreamIfcs:function(){var a=[];g_cfg.get("igmpproxy").each(function(d,c){a.push(c.downstream.devname)});return a},getIfcsForUpstream:function(){var c=this.getDownstreamIfcs(),a=g_cfg.bridge.getPorts();return $.grep(g_net.interfaces,function(d){return $.inArray(d,c)==-1&&$.inArray(d,a)==-1})},getIfcsForDownstream:function(){var c=this.getIfcsForUpstream(),a=g_cfg.get("igmpproxy").upstream.devname,d=$.inArray(a,c);if(d!=-1){c.splice(d,1)}return c},updateIfcDropdowns:function(){var a=g_cfg.get("igmpproxy").upstream.devname,d=$("#igmpUpstream"),c=$("#igmpDownstreamAdd");d.children().remove();$.each(this.getIfcsForUpstream(),function(e,f){var g=$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f));if(f==a){g.prop("selected",true)}d.append(g)});c.children('option[value!="add"]').remove();$.each(this.getIfcsForDownstream(),function(e,f){var g=$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f));c.append(g)})},removeDownstream:function(c){var a=g_cfg.get("igmpproxy");a.objs=a.grep(function(d){return $.inArray(d.downstream.devname,c)==-1})},valid:function(){var e=[];lans=[];for(var d in g_net.lan){if(g_net.lan[d].enabled()){lans.push(g_net.lan[d])}}var c=g_cfg.get("igmpproxy"),a=c.enabled();if(a&&lans.length==0){e.push("Multicast Routing requires at least one LAN interface configured.")}if(a&&this.getDownstreamIfcs().length==0){e.push("Please specify Multicast Downstream interface.")}showErrors($("#igmpErrDiv"),e);return(e.length==0)}},trafficShaping:{headerId:"#headerTShaping",init:function(){var c=$("#tshapingErrDiv"),a=this;$("#tshaping_table").delegate("input.delTShaping","click",function(){var e=$.tmplItem(this).data;g_cfg.tshaper.remove(e);if($(this).closest("tr").find("#edtTSOutBurst").length>0){$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(c);var d=$("#tshapingAdd").prop("disabled");a.fillDevnames();$("#tshapingAdd").prop("disabled",d)}).delegate("input.editTShaping","click",function(){$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",true);var d=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#tshapingEditTmpl").tmpl([d]))}).delegate("input.saveTShaping","click",function(){var e=$.tmplItem(this).data;var d=g_cfg.tshaper.create(e.devname,$("#edtTSInEnable").prop("checked"),$("#edtTSInRate").val(),$("#edtTSInBurst").val(),$("#edtTSOutEnable").prop("checked"),$("#edtTSOutRate").val(),$("#edtTSOutBurst").val(),e.enabled);var f=[];if(d.valid(f)){g_cfg.tshaper.replace(e,d);$(this).closest("tr").replaceWith($("#tshapingTmpl").tmpl([d]));$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",false)}showErrors(c,f)}).delegate("input.enableTShaping","change",function(){$.tmplItem(this).data.enabled(this.checked)}).delegate("#edtTSInEnable","change",function(){var d=!$(this).prop("checked");$("#edtTSInRate").prop("disabled",d);$("#edtTSInBurst").prop("disabled",d)}).delegate("#edtTSOutEnable","change",function(){var d=!$(this).prop("checked");$("#edtTSOutRate").prop("disabled",d);$("#edtTSOutBurst").prop("disabled",d)});$("#tshapingInEnable").change(function(){var d=!$(this).prop("checked");$("#tshapingInRate").prop("disabled",d);$("#tshapingInBurst").prop("disabled",d)});$("#tshapingOutEnable").change(function(){var d=!$(this).prop("checked");$("#tshapingOutRate").prop("disabled",d);$("#tshapingOutBurst").prop("disabled",d)});$("#tshapingAdd").click(function(){var d=g_cfg.tshaper.create($("#tshapingIfc").val(),$("#tshapingInEnable").prop("checked"),$("#tshapingInRate").val(),$("#tshapingInBurst").val(),$("#tshapingOutEnable").prop("checked"),$("#tshapingOutRate").val(),$("#tshapingOutBurst").val(),true);var e=[];if(d.valid(e)){g_cfg.tshaper.add(d);$("#tshaping_table tfoot input[type=text]").val("");$("#tshapingTmpl").tmpl(d).appendTo("#tshaping_table");a.fillDevnames()}showErrors(c,e)});$("#tshapingEnable").change(function(){var d=this.checked;g_cfg.get("tshaper").enabled(d);$("#tshaping_table").toggle(d)});g_net.bind("ifcUsed",this.fillDevnames).bind("ifcUnused",this.fillDevnames)},render:function(){var a=g_cfg.get("tshaper"),c=a.enabled();$("#tshapingEnable").prop("checked",c);$("#tshaping_table > tbody").empty();$("#tshaping_table").toggle(c);this.fillDevnames();$("#tshapingTmpl").tmpl(g_cfg.get("tshaper").objs).appendTo("#tshaping_table")},fillDevnames:function(){var c=g_cfg.getInterfaces(["tshaper"]),d=$.grep(g_cfg.getInterfaces(["board","vlan"]),function(e){return $.inArray(e,c)==-1}),a=$("#tshapingIfc");d.sort();a.children().remove();$.each(d,function(e,f){a.append($("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f)))});$("#tshapingAdd").prop("disabled",d.length==0)}},cfgMode:{init:function(){$("#cfgmode").change(function(d){var c=$(this);if(c.val()=="advancedMode"){$("#network").trigger("beforeSubmit");g_net.setAdvancedCfgMode(true);renderViews()}else{$("#network").trigger("beforeSubmit");if(!g_net.simpleCfgModeApplicable()){if(!confirm("Warning: Changing to simple mode will erase all current advanced networking settings (bridge/vlan/etc)")){c.val("advancedMode");return}var a=g_net.evFns;g_cfg=g_net.switchNetmode(g_cfg.netmode);delete g_cfg.vlan;g_net=ubnt.net.network(g_cfg);g_net.evFns=a}g_net.setAdvancedCfgMode(false);renderViews()}})},render:function(){var a=g_net.advancedCfgMode();$("#cfgmode").val(a?"advancedMode":"simpleMode")}},threeg:{headerId:"#headerThreeG",pinRequired:false,init:function(){var a=this;$("#network").bind("beforeSubmit",function(){if(!a.active){return}var c=g_cfg.get("3g.1");if(a.pinRequired){c.pin.enabled(true);c.pin.code=$("#threegPin").val();c.pin.iccid=a.iccid}c.user=$("#threegUser").val();c.password=$("#threegPassword").val();c.apn=$("#threegApn").val()})},render:function(){var a=this;threegObj=g_cfg.get("3g.1");if(threegObj.pin&&threegObj.pin.enabled()){$("#threegPin").val(threegObj.pin.code);$("#threegPinSection").show().prop("Disabled",true)}else{$("#threegPinSection").toggle(this.pinRequired)}$("#threegUser").val(threegObj.user);$("#threegPassword").val(threegObj.password);$("#threegApn").val(threegObj.apn);$.ajax({url:"status.cgi",cache:false,dataType:"json",success:function(c){if(c&&c.threeg&&c.threeg.sim_status==2){a.pinRequired=true;a.iccid=c.threeg.iccid;$("#threegPinSection").show().prop("Disabled",false)}},error:function(){}})},valid:function(){var d=[];if(this.pinRequired){var c=$("#threegPin").val(),a=c.length;if(a==0){d.push(jsTranslate("SIM Card PIN Code is required."))}else{if(a<4||a>8){d.push(jsTranslate("SIM Card PIN Code is invalid."))}else{$.ajax({url:"/checkpin.cgi?gsmpin="+c,cache:false,dataType:"json",async:false,timeout:3000,success:function(e){if(e.status!=0){d.push(jsTranslate(e.message))}},error:function(){d.push(jsTranslate("Failed to validate PIN Code."))}})}}}showErrors($("#threegErrDiv"),d);return(d.length==0)}}};function showErrors(e,d){var c=[];if(d&&d.length>0){for(var a=0;a<d.length;++a){if(c.length>0){c.push("<br/>")}if(d[a].length>0){c.push(d[a])}}}e.html(c.join("")).toggle(c.length>0)}function filterEnabledIfcs(a){return $.grep(a,function(c){return !!g_cfg.netconf.findByDevname(c,true)})}function quickFixForSinglePortDevices(){if(g_board.board.phycount>1){return}$.each(g_cfg.netconf.find({devname:"eth1"}),function(d,c){g_cfg.netconf.remove(c)});$.each(g_cfg.bridge.objs,function(c,d){var e=d.port.find({devname:"eth1"});$.each(e,function(f,g){d.port.remove(g)})});var a=g_cfg.get("vlan").find({devname:"eth1"});if(a.length){$.each(a,function(f,e){var g=e.getFullDevname(),d=g_cfg.get("netconf").find({devname:g}),c=g_cfg.get("ebtables.sys.vlan"),h=c.find({devname:e.devname,id:e.id});g_cfg.vlan.remove(e);$.each(g_cfg.bridge.objs,function(i,k){var j=k.port.find({devname:g});$.each(j,function(l,m){k.port.remove(m)})});$.each(d,function(j,i){g_cfg.netconf.remove(i)});$.each(h,function(i,j){c.remove(j)});c.enabled(c.objs.length)})}}function initViews(){$.each(views,function(a,c){c.init()})}function renderViews(){var i={bridge:{simple:["netmode","disableNet","mlan","cfgMode"],advanced:["netmode","disableNet","mlan","ifaces","aliases","vlan","bridge","firewall","routes","trafficShaping","cfgMode"]},router:{simple:["netmode","disableNet","wan","lan","portForward","igmp","cfgMode"],advanced:["netmode","disableNet","wan","lan","mlan","ifaces","aliases","vlan","bridge","firewall","routes","portForward","igmp","trafficShaping","cfgMode"]},soho:{simple:["netmode","disableNet","wan","lan","portForward","igmp","cfgMode"],advanced:["netmode","disableNet","wan","lan","mlan","ifaces","aliases","vlan","bridge","firewall","routes","portForward","igmp","trafficShaping","cfgMode"]},"3g":{simple:["netmode","disableNet","threeg","lan","portForward","igmp","cfgMode"],advanced:["netmode","disableNet","threeg","lan","mlan","ifaces","aliases","vlan","bridge","firewall","routes","portForward","igmp","trafficShaping","cfgMode"]},airfiber:{simple:["netmode","mlan","cfgMode"],advanced:["netmode","mlan","cfgMode"]}},h=i[g_cfg.netmode][g_net.advancedCfgMode()?"advanced":"simple"],d=($.cookie("netCollapsed")||"#headerIfaces,#headerVlan,#headerBridge,#headerFirewall,#headerRoutes,#headerPortFwd,#headerAliases,#headerIgmp,#headerTShaping").split(",");for(var g in views){var f=$.inArray(g,h)!=-1,a=views[g];a.active=f;if(a.headerId){var c=$.inArray(a.headerId,d)!=-1,e=$(a.headerId);if(g_cfg.netmode=="airfiber"&&(g=="netmode"||g=="cfgMode")){e.toggle(false).next().toggle(false)}else{e.toggle(f).next().toggle(f&&!c)}if(c){e.addClass("active")}}if(f){a.render()}}$(".simple-only").toggle(!g_net.advancedCfgMode())}function validateFields(d,a,c){$.each(a,function(e,g){var h=d.find(g.field).val();if(g.req&&!h){c.push(g.name+" can not be empty.")}else{if(h){if(g.valid&&!g.valid(h)){c.push(g.name+" is invalid.")}else{if(g.min||g.max){var f=parseInt(h);if((g.min&&f<g.min)||(g.max&&f>g.max)){c.push(g.name+" is out of range ["+g.min+"-"+g.max+"].")}}}}}})}function viewsValid(){var c=true,a;$.each(views,function(d,e){if(e.active&&e.valid){if(!e.valid()){c=false;$(e.headerId).removeClass("active").next().show()}}});a=$(".errors:visible");if(!c&&a.length){$("html,body").scrollTop(a.offset().top)}return c}function getConfiguration(){$.ajax({url:"getcfg.sh",data:".",type:"GET",dataType:"text",success:function(a){g_cfg=ubnt.cfg.parse(a);quickFixForSinglePortDevices();g_net=ubnt.net.network(g_cfg);$("#netmode").val(g_cfg.netmode);initViews();renderViews()},error:function(c,a){alert("Failed!")}})}$(document).ready(function(){$("h2.trigger").click(function(){var a="";$(this).toggleClass("active").next().slideToggle("fast");$(".active").each(function(){a=a+(a?",#":"#")+this.id});$.cookie("netCollapsed",a);return false});$(".pwd").attr("autocomplete","off").passwd({label:jsTranslate("Show"),migrate_attrs:["maxLength"]}).next().next().css("text-align","left");$.ajax({url:"getboardinfo.sh",type:"GET",dataType:"text",success:function(a){g_board=ubnt.cfg.parse(a);getConfiguration()},error:function(c,a){alert("Failed!")}});$("#show_cfg").click(function(){$("#network").trigger("beforeSubmit");g_net.updateStatuses();$("#debug_cfg").html(ubnt.cfg.toCfg(g_cfg).join("<br />"))});$("#network").submit(function(){try{$("#network").trigger("beforeSubmit");if(viewsValid()){g_net.updateStatuses();$("#network_data").val(ubnt.cfg.toCfg(g_cfg).join("\r\n"));return true}}catch(a){alert("An error has occurred: "+a.message)}return false});fwUpdateCheck(false,fw_check)});