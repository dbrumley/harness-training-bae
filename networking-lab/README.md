## Network Binary Lab
In this lab, we will package a network binary for analysis through
Mayhem. This will also cover more in depth the configuration
options for Mayhem.

### Background
This is an introductory lab to teach students how Mayhem accepts
binaries listening on a network socket easily and without harnessing.
Fuzzing networked targets is challenging.  It raises the question:
how does one control the data sent over the socket?  At ForAllSecure we
solve this by emulating network calls.  In this lab we explore fuzzing
a networked target, and some of the more complex aspects of harnessing,
including identifying missing modules and configuration files
required by the target.

### Requirements
* Mayhem
* Your favorite editor

### Mayhem Configuration
The SMART config for networked targets requires specific fields to be
populatated.  The fields are as follows:

* URL: This contains the protocol the target uses (udp or tcp), the ip
address of the target (localhost), and the port the target listens/connects
on.  It has the form: `<protocol>://localhost:<port>`
* is_client: True or False dependening on whether or not the target is
a client
* timeout: Timeout in ms of how long to wait before closing the network
connection

Here is an example config:
```
{
    "fuzzers": [
        {
            "target": "root/myserver",
            "target_args": [],
            "network": {
                "url": "udp://localhost:124",
                "is_client": false,
                "timeout" : 2000
            }
        }
    ]
}
```
### Example 1: NGINX

NGINX is a popular web server.  Below we walk through the steps of how
to run Mayhem on it.

NGINX can be installed with:
`sudo apt-get install nginx`

1. Package the target: `mayhem package /usr/sbin/nginx -o nginx_package`.  If
you omit the `-o` argument, mayhem will generate a randomly-named directory in
`/tmp/`.
2. Edit the `config.json` file in the package directory to add required
commandline arguments for NGINX.  NGINX is run as follows:
`nginx -p . -c nginx.conf`
which is what we need to fill out the `target_args` field.

    ```
    {
        "fuzzers": [
            {
                "target_args": ["-p", ".", "-c", "root/nginx.conf"],
                "target": "root/usr/sbin/nginx",
                "asan": false,
                "libfuzzer": false,
                "library_path": "root/lib/x86_64-linux-gnu:root/usr/lib/x86_64-linux-gnu"
            }
        ]
    }
    ```

3. Add the network fields to the config.  NGINX listens on port 80 and is
TCP.

    ```
    {
        "fuzzers": [
            {
                "target_args": ["-p", ".", "-c", "root/nginx.conf"],
                "target": "root/usr/sbin/nginx",
                "network" : {
                    "url" : "tcp://localhost:8080",
                    "timeout" : 2000,
                    "is_client" : false
                },
                "asan": false,
                "libfuzzer": false,
                "library_path": "root/lib/x86_64-linux-gnu:root/usr/lib/x86_64-linux-gnu"
            }
        ]
    }
    ```

4. The NGINX configuration file is provided in `./nginx/nginx.conf`.  Copy this to
the `root/` directory generated by `mayhem package`.  

5. Upload to Mayhem and begin fuzzing.
`mayhem upload nginx_package/ --start-sword --duration 30`.   
(Hint: if you get an error about invalid JSON, you can use 
`python -m json.tool ./path/to/file`
to get an idea about what is incorrect).

If everything went right, you should see a stair-step pattern in an upward
curve on the graph and it should list many edges covered and multiple tests
stored.  If you see only one upward tick on the graph and only see one test
stored, you probably need to check that the config.json file matches the
correct invocation and that you have the files in the locations the target
expects.


### Example 2: Bacsrv
Mayhem is straightforward to use if you know how to run the target application.
However, this isn't always the case.  Often at ForAllSecure we know
nothing about the target.  Below we walk through our workflow for
how to run Mayhem on an unknown target.

The target is bacsrv, a little known server program. A good start is:

1.  Get context by googling the target.  We see Bacnet is a data
communication protocol for building automation control and
networks.  Bacsrv implements this protocol.

2. Run `mayhem package` to pull all the dependencies for the binary
  and create a default Mayhem configuration file.

3. Edit the network config.  Follow the below steps to figure out
the correct information:

    a. Run the target to see if it provides anything useful.

    ```
    $ ./bacserv
    BACnet Server Demo
    BACnet Stack Version 0.9.1
    BACnet Device ID: 260001
    Max APDU: 1476
    ```

    Unfortunately, the above output doesn't tell us anything.

    b.  Run strace to identify the port and protocol.

    ```
    strace -f -o /tmp/slog ./bacsrv
    ```

    `-f` indicates follow children, and `-o` is the file our results are written to.

    c.  Because this is a server, we know it binds to a port.  Grep for bind in the results:
    ```
    $ grep bind /tmp/slog
    20399 bind(3, {sa_family=AF_INET, sin_port=htons(47808), sin_addr=inet_addr("0.0.0.0")}, 16) = 0
    ```
    We see that the target is IPV4 (AF_INET) and bound to port 47808.

    d.  To identify the protocol, grep for `socket`.
    ```
    $ grep socket /tmp/slog
    20399 socket(PF_INET, SOCK_DGRAM, IPPROTO_IP) = 3
    20399 socket(PF_INET, SOCK_DGRAM, IPPROTO_IP) = 3
    20399 socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP) = 3
    ```
    We see this uses UDP.

4.  After filling this information into the config file, the package is ready.
To begin fuzzing run:
`mayhem upload bacnet/ --start-sword --duration 30`

### Tips
* Try running the target with `-h` or `--help` to get the help menu to see 
what switches or capabilities are available in the target.  Always look
for the option to run the target in the foreground (i.e. don't daemonize).
* Strace can be used to identify missing configuration files or modules.
* A good starting corpus is very important as it avoids having mayhem spend
time trying to figure out what normal input looks like.  A good place to start
is by capturing real network requests.

### Exercise: Lighttpd
There are two variants of the lighttpd exercise: moderate and hard.

1. Moderate:  The student must edit `lighttpd_package/config.json` to reflect the
correct commandline arguments and network settings. The package is already
provided in `lighttpd_package`. The command for how to run lighttpd is provided
in `lighttpd_package/run.sh`. The port and protocol lighttpd uses is specified
in `lighttpd_package/README.md`.  Once the student has completed this task,
upload the package and review the fuzzing results (looking for an upward trend
in the graph and many test cases generated).

2. Hard: The student can install lighttpd on their own, run `mayhem package`,
add missing dependencies (lighttpd requires modules and a configuration file),
and determine the port/protocol required by lighttpd.

### Conclusion
This lesson went into the details of the Mayhem configuration file and showed
how to package network binaries and their dependencies.

